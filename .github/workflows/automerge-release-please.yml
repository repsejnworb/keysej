name: automerge-release-please

on:
  workflow_run:
    workflows: ["ci"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Download PR data
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const prs = run.pull_requests || [];
            if (prs.length === 0) {
              core.setOutput('found', 'false');
              return;
            }
            const prNum = prs[0].number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNum,
            });
            core.setOutput('found', 'true');
            core.setOutput('number', prNum);
            core.setOutput('author', pr.user.login);
            core.setOutput('labels', pr.labels.map(l => l.name).join(','));
      - name: Stop if no PR info
        if: steps.pr.outputs.found != 'true'
        run: echo "No PR linked to this CI run"

      - name: Enable auto-merge (squash)
        if: >
          steps.pr.outputs.found == 'true' &&
          (
            steps.pr.outputs.author == 'github-actions[bot]' ||
            steps.pr.outputs.author == 'release-please[bot]'
          ) &&
          contains(steps.pr.outputs.labels, 'autorelease: pending')
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.pr.outputs.number }}
          merge-method: squash
